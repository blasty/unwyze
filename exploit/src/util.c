#include <ctype.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <stdbool.h>
#include <stdarg.h>

#include "util.h"

void hexdump(void *ptr, int buflen)
{
    unsigned char *buf = (unsigned char *)ptr;
    int i, j;
    for (i = 0; i < buflen; i += 16)
    {
        printf("%06x: ", i);
        for (j = 0; j < 16; j++)
            if (i + j < buflen)
                printf("%02x ", buf[i + j]);
            else
                printf("   ");
        printf(" ");
        for (j = 0; j < 16; j++)
            if (i + j < buflen)
                printf("%c", isprint(buf[i + j]) ? buf[i + j] : '.');
        printf("\n");
    }
}

uint16_t rbe16(uint8_t *p, uint32_t offset)
{
    return (p[offset] << 8) | p[offset + 1];
}

uint16_t le16(uint8_t *p)
{
    return p[0] | (p[1] << 8);
}

uint32_t le32(uint8_t *p)
{
    return p[0] | (p[1] << 8) | (p[2] << 16) | (p[3] << 24);
}

uint16_t be16(uint8_t *p)
{
    return (p[0] << 8) | p[1];
}

uint32_t be32(uint8_t *p)
{
    return (p[0] << 24) | (p[1] << 16) | (p[2] << 8) | p[3];
}

void wle16(uint8_t *p, uint16_t val)
{
    p[0] = (val & 0xff);
    p[1] = (val >> 8) & 0xff;
}

void wbe16(uint8_t *p, uint16_t val)
{
    p[0] = (val >> 8) & 0xff;
    p[1] = (val & 0xff);
}

void wbe32(uint8_t *p, uint32_t val)
{
    p[0] = (val >> 24) & 0xff;
    p[1] = (val >> 16) & 0xff;
    p[2] = (val >> 8) & 0xff;
    p[3] = (val & 0xff);
}

void wle32(uint8_t *p, uint32_t val)
{
    p[0] = (val & 0xff);
    p[1] = (val >> 8) & 0xff;
    p[2] = (val >> 16) & 0xff;
    p[3] = (val >> 24) & 0xff;
}

void wle64(uint8_t *p, uint64_t val)
{
    p[0] = (val & 0xff);
    p[1] = (val >> 8) & 0xff;
    p[2] = (val >> 16) & 0xff;
    p[3] = (val >> 24) & 0xff;
    p[4] = (val >> 32) & 0xff;
    p[5] = (val >> 40) & 0xff;
    p[6] = (val >> 48) & 0xff;
    p[7] = (val >> 56) & 0xff;
}

uint8_t *slurp_file(char *fn, long *size_out)
{
    FILE *f = fopen(fn, "rb");
    fseek(f, 0, SEEK_END);
    *size_out = ftell(f);
    rewind(f);
    uint8_t *buf = malloc(*size_out);
    if (fread(buf, *size_out, 1, f) != 1)
    {
        printf("couldnt load '%s'\n", fn);
        exit(-1);
    }
    fclose(f);
    return buf;
}

void report(char indicator, bool error, const char *fmt, ...)
{
    FILE *stream = (error) ? stderr : stdout;
    va_list a;
    va_start(a, fmt);
    fprintf(stream, "  [%c] %s", indicator, (error) ? "ERROR: " : "");
    vfprintf(stream, fmt, a);
    fprintf(stream, "\n");
    va_end(a);

    if (error)
    {
        exit(-1); // all errors are fatal
    }
}

uint32_t ip2addr(char *ip)
{
    uint8_t a, b, c, d;
    if (sscanf(ip, "%hhu.%hhu.%hhu.%hhu", &a, &b, &c, &d) < 4)
    {
        return 0;
    }

    return (a << 24) | (b << 16) | (c << 8) | d;
}
